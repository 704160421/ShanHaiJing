(function(){"use strict";var v=MugineRequire("Utils/Module"),O=MugineRequire("Display/Shape"),M=MugineRequire("Utils/Plugin"),A=MugineRequire("Utils/mugedaAPIAObject"),R=MugineRequire("Action/Action"),d=function(){d.__super__.constructor.apply(this,arguments);var e=this;e._activeDrop=!1,e._objects=[]};v.extend(d,O);var c=d.prototype;c._type="Dragger",c._getText=function(e){return(this._objects[e||0]||{})._name||""},c._getScore=function(){return this._score},c._getValue=function(){return this._value},c._getQuestionData=function(e={}){const a=this,i=e.noAnswer||e.noAnswer||!1,t=a._question,r=t.data,n=a._aniData.param;var s={id:t.tikuId,type:t.type,title:this._getName(),issue:"",correctScore:r.tickling.correct.score,errorScore:r.tickling.err?r.tickling.err.score:0};s.options=n.dragObjects.map(function(u){return{name:u}}),s.correctAnswer=n.expectedObjects;var o={};return i||(o={score:a._getScore(),answerState:a._interacted?a._userValue.correct:"unanswered",answers:a._userValue.input}),[{...s,...o}]},c._setTikuId=function(e,a,i){try{var t=JSON.parse(e.param.question)}catch{console.log("fail to parse question",e);return}t={...t,tikuId:a},e.param.question=JSON.stringify(t)},c._onDropped=function(e,a,i){var t=this,r=t._aniData.param,n=!i&&a,s=!1,o=(r.dragObjects||[]).indexOf(e._name);if(n){var o=t._objects.indexOf(e);o>=0&&t._objects.splice(o,1)}else if(o>=0)if(a&&a.lastDropped==e)r.multipleDraggers?t._objects.indexOf(e)==-1&&t._objects.push(e):(t._objects.forEach(function(p){p._id!=e._id&&p._reset()}),t._objects=[e]);else{s=!0;for(var u=0;u<t._objects.length;u++)if(t._objects[u]._name==e._name){t._objects.splice(u,1);break}s&&r.draggerReset&&e._reset()}else i&&(s=!0,s&&r.draggerReset&&e._reset());t._dispatchEvent(t._changedEvent),t._activeDrop=!1},c._dropTestWithUpdate=function(e,a,i){let t=this,r=t._dropTest(e,a,i);return r.canDrop!=t._activeDrop&&(t._activeDrop=r.canDrop,t._interacted=!0,t._dispatchEvent(t._changedEvent)),r},c._dropTest=function(e,a,i){var t=this,r=t._aniData.param,n={container:t},s=t._getRect();let o="";e._parent&&e._parent._name?o=e._parent._name+" - "+e._name:o=e._name;var u=(r.dragObjects||[]).indexOf(o);if(u>=0){n.candidate=!0;var r=t._aniData.param,p=32,D=(s.left+s.right)/2,g=(s.top+s.bottom)/2,l=D-a,b=g-i,f=Math.max(p,(s.right-s.left)/2),y=Math.max(p,(s.bottom-s.top)/2);n.canDrop=Math.abs(l)<f&&Math.abs(b)<y,r.draggerPosition&&(n.x=D,n.y=g),n.canDrop!=t._activeDrop&&(t._activeDrop=n.canDrop,t._interacted=!0,t._dispatchEvent(t._changedEvent))}return n},c._reset=function(){var e=this,a=e._aniData.param;e._objects.map(function(i){i._reset()}),e._objects=[],a.showActive&&setTimeout(function(){e._dispatchEvent(e._changedEvent)},1),e._activeDrop=!1,d.__super__._reset.apply(e,arguments)},d._createChildClass=function(e,a){var i=function(t){var r=this;i.__super__.constructor.apply(this,arguments),t&&t.addChild(r),r._aniData=e;try{r._question=JSON.parse(e.param.question||"{}")}catch{console.log("fail to parse question",e),r._question={}}};return v.extend(i,d),i},d._createAObject=function(){var e=function(i,t){var r=this;e.__super__.constructor.apply(r,arguments),v.definePropertyReadOnly(r,["score",r._getScore])};v.extend(e,A);var a=e.prototype;return a._getScore=function(){return this._displayObject._getScore()},e},c._createActionClass=function(){var e=this,a=function(t,r){a.__super__.constructor.apply(this,arguments),this._targetObject=e};v.extend(a,R);var i=a.prototype;return i.doAction=function(t){var r=this;r.logicPositive()&&(r._targetObject&&r._targetObject._reset(),a.__super__.doAction.apply(r,arguments))},a},v.exportName(c,["getQuestionData",c._getQuestionData,"setTikuId",c._setTikuId]),v.namespace("Shape.DisplayObjectDragger",d),M._registerDisplayObjectClass(2050,d);var q=MugineRequire("Utils/Module"),x=MugineRequire("Utils/Plugin"),S=MugineRequire("Render/RenderObjectShape"),k=MugineRequire("Render/StyleSheet"),h=function(){h.__super__.constructor.apply(this,arguments);var e=this;e._updateMode="replaceSVG"};q.extend(h,S);var m=h.prototype;m._setDisplayInitState=function(){var e=this,a=e._displayObject,i=a._aniData.param;a._aniData.curve.points,e.constructor.__super__._setDisplayInitState.apply(e,arguments);var t=e._html.lastIndexOf("</div>");if(t>0){var r=t>0?e._html.substr(0,t):e._html,n='<div class="dragger_'+a._id+'"></div>',s="position: absolute;overflow:visible; margin:0; opacity: 0;background-color: "+(i.draggerColor||"rgba(255,0,0,255)")+";width: 100%;height: 100%;left: 0px; top: 0px; ";a._anchorCount==0&&(s+="visibility: hidden;"),k.insertCss("dragger_"+a._id,s),r+=n,r+="</div>",e._html=r}var o=a._getStage()._renderManager;o._dropObjectList.push({container:a})},m._buildFun=function(){var e=this;h.__super__._buildFun.apply(e,arguments);var a=e._displayObject;a._addEventListener("changed",e._checkAns.bind(e)),this._checkAns()},m.render=function(e,a,i){var t=this,r=t._displayObject;h.__super__.render.apply(t,arguments);var n=r._aniData.param,s=t.getNode(),o=s.querySelector(".dragger_"+r._id);n.showActive&&o&&(o.style.opacity=r._activeDrop?.5:0)},m._checkAns=function(e){var j;var a=this,i=a._displayObject,t=!1;if(e&&e.strictMulti!==void 0)t=e.strictMulti;else{var r=a._displayObject._getRoot()._aniData;r.metadata.question&&(t=!!r.metadata.question.strictMulti)}var n=i._question;if(!n.data)return;try{var s=n.data.tickling.correct.score*1}catch{s=0}try{var o=n.data.items}catch{o=[]}try{var u=n.data.tickling.err.score*1}catch{u=0}var p=0,D=i._aniData.param.dragObjects||[],g=i._objects.map(_=>_.name);let l="incorrect",b=g.every(_=>o.includes(_));b&&g.length===o.length?(l="correct",p=s):b?t?(l="incorrect",p=u):(l="partiallyCorrect",p=s*g.length/o.length):(l="incorrect",p=u);var f=[];Array.isArray((j=n==null?void 0:n.data)==null?void 0:j.items)&&n.data.items.forEach(_=>{f.push(_)}),i._value=g.join(","),i._correct=l==="correct",i._correctList=f,i._score=p,i._total=s,i._userValue={input:g.map(_=>({name:_,correct:o.indexOf(_)!==-1})),score:i._score,correct:l};let y=[];return D.forEach((_,C)=>{y.push({correct:f.indexOf(_)>-1,serial:C+1,desc:_})}),i._formateQuestionData={issue:"",items:y,tickling:n.data.tickling,type:"dragger"},l==="correct"},x._registerRenderObjectClass(2050,h)})();
